{% extends 'backend/base.html' %}

{% block title %} Product List {% endblock %}

{% block content %}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Products</h1>
</div>


<div class="card">
  <form action="{% url 'product:product_list' %}" method="get" class="card-header" id="filter-form">
    <div class="form-row justify-content-between">
      <div class="col-md-2">
        <input type="text" name="title" id="title-input" placeholder="Product Title" class="form-control">
      </div>
      <div class="col-md-2">
        <select name="variant" id="variant-select" class="form-control">
          <option selected disabled>--Select A Variant--</option>
          {% for variant in variants %}
            <optgroup label="{{ variant.variant }}">
              {% for product_variant in variant.product_variants %}
                <option value="{{ product_variant.id }}">{{ product_variant.variant_title }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">Price Range</span>
          </div>
          <input type="text" name="price_from" id="price-from-input" aria-label="From" placeholder="From" class="form-control">
          <input type="text" name="price_to" id="price-to-input" aria-label="To" placeholder="To" class="form-control">
        </div>
      </div>
      <div class="col-md-2">
        <input type="date" name="date" id="date-input" placeholder="Date" class="form-control">
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary float-right"><i class="fa fa-search"></i></button>
      </div>
    </div>
  </form>

    <div id="product-list" class="card-body">
        <div class="table-response">
            <table class="table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Variant</th>
                    <th width="150px">Action</th>
                </tr>
                </thead>

                <tbody>
                {% for product in product_list %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ product.title }}<br> Created at: {{ product.created_at }}</td>
                    <td>{{ product.description }}</td>
                    <td>
                        <dl class="row mb-0" style="height: 80px; overflow: hidden" id="variant">
                          {% for product_variant in product_variants %}
                          {% if product_variant.variant %}
                              <dt class="col-sm-3 pb-0">
                                  {{ product_variant.variant.variant_title }}
                              </dt>
                              <dd class="col-sm-9">
                                  <dl class="row mb-0">
                                      {% for variant in product_variant.product_variants %}
                                          <dd class="col-sm-4 pb-0">Price: {{ variant.price }}</dd>
                                          <dd class="col-sm-8 pb-0">InStock: {{ variant.stock }}</dd>
                                      {% endfor %}
                                  </dl>
                              </dd>
                          {% endif %}
                          {% endfor %}
                        <button onclick="$('#variant').toggleClass('h-auto')" class="btn btn-sm btn-link">Show more</button>
                    </td>
                    <td>
                      <form method="post" action="{% url 'product:update_product' pk=product.id %}">
                        {% csrf_token %}
                        {{ form.as_p }}
                        <button type="submit" class="btn btn-primary">Update</button>
                      </form>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

    <div class="card-footer">
        <div class="row justify-content-between">
            <div class="col-md-6">
                <p>Showing 1 to {{ products|length }} out of {{ total_products }}</p>
            </div>
            <div class="col-md-2">

            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    $('#variant-select').change(function() {
      var selectedVariant = $(this).val();
      var currentURL = window.location.href;

      // Remove existing 'variant' parameter from URL
      currentURL = currentURL.replace(/([?&])variant=[^&]+(&|$)/, '$1').replace(/([?&])$/, '');

      // Add selected variant to URL as a parameter
      if (selectedVariant) {
        currentURL += (currentURL.includes('?') ? '&' : '?') + 'variant=' + selectedVariant;
      }

      // Redirect to the updated URL
      window.location.href = currentURL;
    });

    // Attach event listener to the form submit event
    $('#filter-form').submit(function(event) {
      event.preventDefault(); // Prevent form submission

      // Get the filter values from the input elements
      var title = $('#title-input').val().trim();
      var priceFrom = parseFloat($('#price-from-input').val());
      var priceTo = parseFloat($('#price-to-input').val());
      var date = $('#date-input').val().trim();

      // Perform AJAX request to filter the products
      $.ajax({
        url: '/product/list/',
        method: 'GET',
        data: {
          title: title,
          price_from: priceFrom,
          price_to: priceTo,
          date: date
        },
        success: function(data) {
          // Handle the response and update the product list
          updateProductList(data);
        },
        error: function() {
          // Handle the error
          console.error('Filtering products failed.');
        }
      });
    });

    // Function to update the product list on the page
    function updateProductList(products) {
      var productListContainer = $('#product-list');
      productListContainer.empty();

      if (products.length === 0) {
        productListContainer.append('<p>No products found.</p>');
      } else {
        $.each(products, function(index, product) {
          var productHTML = '<div class="product">';
          productHTML += '<h3>' + product.title + '</h3>';
          productHTML += '<p>' + product.description + '</p>';
          productHTML += '</div>';

          productListContainer.append(productHTML);
        });
      }
    }
  });
</script>


{% endblock %}